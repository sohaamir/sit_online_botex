{% extends "global/Page.html" %}
{% load staticfiles otree %}
{% load otree %}

{{ block content }}

<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    #content {
        height: 100vh;
        overflow-y: auto;
    }

    body {
        background-color: black;
        color: white;
        font-size: 24px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        height: 150vh;
        margin: 0;
        transform: scale(1.1);
        transform-origin: top center;
    }

    #option-container {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        width: 900px;
        height: 600px;
        border: 7.5px solid white;
        padding: 30px;
        box-sizing: border-box;
    }

    #options {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
        margin-top: 45%;
        position: relative;
    }

    #options img {
        width: 10%;
        margin: 0;
    }

    #option_left {
        position: absolute;
        left: 25%;
        transform: translateX(-50%);
    }

    #option_right {
        position: absolute;
        right: 25%;
        transform: translateX(50%);
    }

    .title {
        text-align: center;
        position: absolute;
        top: -45px;
        left: 50%;
        transform: translateX(-50%);
        white-space: pre-line;
    }

    #preference-title {
        top: -90px;
    }

    .selected {
        border: 4.5px solid yellow;
    }

    .selected-from-previous {
        border: 4.5px solid orange;
    }

    .bet-options {
        display: flex;
        justify-content: center;
        margin-top: 60px;
    }

    .bet-options div {
        margin: 0 15px;
        padding: 7.5px 15px;
        cursor: pointer;
    }

    .bet-options div.selected {
        border: 3px solid yellow;
    }

    #avatar-container {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        top: 105px;
        left: -25px;
    }

    .avatar-wrapper {
        position: relative;
        display: inline-block;
        margin: 0 15px;
    }

    .avatar-number {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 20px;
        font-weight: bold;
        color: black;
        z-index: 1;
        pointer-events: none;
    }

    .avatar {
        width: 75px;
        height: 75px;
    }

    .chosen-image {
        width: 45px;
        height: 45px;
        position: absolute;
        top: 82.5px;
        left: 15px;
    }

    .second-chosen-image {
        width: 45px;
        height: 45px;
        position: absolute;
        top: 82.5px;
        left: 15px;
    }

    .remaining-image {
        width: 45px;
        height: 45px;
        position: absolute;
        top: 82.5px;
        left: 15px;
    }

    .avatar-selected {
        border: 4.5px solid rgb(249, 0, 0);
    }

    .avatar-selected-second-choice {
        border: 4.5px solid rgb(255, 166, 0);
    }

    .otree-timer {
        display: none;
    }

    #player-win-loss-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    #player-win-loss-image {
        width: 75px;
        height: 75px;
    }

    #trial-reward {
        color: rgb(30, 236, 30);
        font-size: 36px;
        margin-top: 4.5px;
        font-weight: bold;
        text-align: center;
    }

    .win-loss-image {
        width: 37.5px;
        height: 37.5px;
        position: absolute;
        top: 157.5px;
        left: 30px;
    }
</style>

<form id="form">
    <div id="avatar-container">
        {% for player_id in other_player_ids %}
            <div class="avatar-wrapper" data-player-id="{{ player_id }}">
                <img src="{% static avatar_image %}" alt="Player {{ player_id }} Avatar" class="avatar">
                <div class="avatar-number">{{ forloop.counter }}</div>
                <div class="chosen-images-container">
                    <img src="" alt="Player {{ player_id }} Chosen Image (First Choice)" class="chosen-image chosen-image-first" style="display: none;">
                    <img src="" alt="Player {{ player_id }} Chosen Image (Second Choice)" class="chosen-image chosen-image-second" style="display: none;">
                    <img src="" alt="Player {{ player_id }} Win/Loss Image" class="win-loss-image" style="display: none;">
                </div>
            </div>
        {% endfor %}
    </div>

    <div id="option-container">
        <div id="options">
            <img src="{% static left_image %}" id="option_left" data-option="left">
            <img src="{% static right_image %}" id="option_right" data-option="right">
            <div class="title" id="choice-title">Your choice?</div>
            <div class="title" id="second-choice-title" style="display: none;">Second choice?</div>
            <div class="title" id="bet-title" style="display: none;">Your bet?</div>
            <div class="title" id="second-bet-title" style="display: none;">Second bet?</div>
        </div>
        <div id="bet-container" style="display: none;">
            <div class="bet-options">
                <div data-bet="1">1</div>
                <div data-bet="2">2</div>
                <div data-bet="3">3</div>
            </div>
        </div>
        <div id="player-win-loss-container" style="display: none;">
            <img src="" alt="Player Win/Loss Image" id="player-win-loss-image">
        </div>
        <div id="trial-reward" style="display: none;"></div>
        {{ formfield_errors 'choice1' }}
        {{ formfield_errors 'bet1' }}
        {{ formfield_errors 'choice2' }}
        {{ formfield_errors 'bet2' }}
        <input type="hidden" name="choice1" id="choice1_field">
        <input type="hidden" name="bet1" id="bet1_field">
        <input type="hidden" name="choice2" id="choice2_field">
        <input type="hidden" name="bet2" id="bet2_field">
    </div>
</form>

<script>
    window.otherPlayerIds = {{ other_player_ids|json }};
    window.chosenImages = {{ chosen_images|json }};

    let choicePhaseStartTime;
    let betPhaseStartTime;
    let secondChoiceStartTime;
    let secondBetStartTime;
    let initialChoiceTime;
    let initialBetTime;
    let currentStage = 'choice';
    let initialChoiceTimerId;
    let choiceMade = false;
    let betMade = false;
    let secondChoiceMade = false;
    let secondBetMade = false;
    let individualPageLoadTime;
    let betTimerStarted = false;
    let betPhaseEnded = false;
    let secondBetPhaseEnded = false;
    let resultsShown = false;

    document.addEventListener('DOMContentLoaded', function() {
        individualPageLoadTime = performance.now();
        liveSend({
            page_load_time: performance.now(),
            individual_page_load_time: individualPageLoadTime
        });
        
        // Timeout logic
        const pageStartTime = js_vars.page_start_time;
        const timeoutDuration = 4200000; // 42 seconds in milliseconds

        function checkTimeout() {
            const currentTime = new Date().getTime();
            if (currentTime - pageStartTime >= timeoutDuration) {
                document.getElementById('form').submit();
            } else {
                setTimeout(checkTimeout, 1000); // Check every second
            }
        }

        setTimeout(checkTimeout, 1000); // Start checking after 1 second
    });

    function handleKeyDown(event) {
        if (currentStage === 'choice' && (event.key === 'ArrowLeft' || event.key === 'ArrowRight') && !choiceMade) {
            initialChoiceTime = performance.now() - individualPageLoadTime;
            liveSend({
                initial_choice_time: initialChoiceTime, 
                actual_choice_time: performance.now() - choicePhaseStartTime,
                choice: event.key === 'ArrowLeft' ? 'left' : 'right'
            });
            choose(event.key === 'ArrowLeft' ? 'left' : 'right');
            choiceMade = true;
        } 
        else if (currentStage === 'bet' && (event.key >= '1' && event.key <= '3') && !betMade) {
            const bet = parseInt(event.key);
            const initialBetTime = performance.now() - betPhaseStartTime;
            liveSend({
                initial_bet_time: initialBetTime, 
                bet: bet, 
                id: js_vars.player_id
            });
            selectBet(bet);
            betMade = true;
        }
        else if (currentStage === 'second_choice' && (event.key === 'ArrowLeft' || event.key === 'ArrowRight') && !secondChoiceMade) {
            const secondChoiceTime = performance.now() - secondChoiceStartTime;
            liveSend({
                second_choice_time: secondChoiceTime,
                second_choice: event.key === 'ArrowLeft' ? '{{ player.left_image }}' : '{{ player.right_image }}'
            });
            chooseSecond(event.key === 'ArrowLeft' ? 'left' : 'right');
            secondChoiceMade = true;
        }
        else if (currentStage === 'second_bet' && (event.key >= '1' && event.key <= '3') && !secondBetMade && !secondBetPhaseEnded) {
            const bet = parseInt(event.key);
            const secondBetTime = performance.now() - secondBetStartTime;
            liveSend({
                second_bet: bet,
                second_bet_time: secondBetTime
            });
            selectSecondBet(bet);
            secondBetMade = true;
        }
    }

    document.addEventListener('keydown', handleKeyDown);

    function choose(option) {
        if (currentStage === 'choice' && !choiceMade) {
            const selectedOption = document.getElementById(`option_${option}`);
            const otherOption = document.getElementById(`option_${option === 'left' ? 'right' : 'left'}`);
            selectedOption.classList.add('selected');
            otherOption.classList.remove('selected');
            document.getElementById('choice1_field').value = option;
            choiceMade = true;
        }
    }

    function chooseSecond(option) {
        if (currentStage === 'second_choice' && !secondChoiceMade) {
            const selectedOption = document.getElementById(`option_${option}`);
            const otherOption = document.getElementById(`option_${option === 'left' ? 'right' : 'left'}`);
            selectedOption.classList.add('selected');
            selectedOption.classList.remove('selected-from-previous');
            otherOption.classList.remove('selected');
            otherOption.classList.remove('selected-from-previous');
            document.getElementById('choice2_field').value = option;
            secondChoiceMade = true;
        }
    }

    function selectBet(bet) {
        const betElements = document.querySelectorAll('.bet-options div');
        betElements.forEach(element => {
            element.classList.remove('selected');
        });
        const selectedBetElement = document.querySelector(`.bet-options div[data-bet="${bet}"]`);
        if (selectedBetElement) {
            selectedBetElement.classList.add('selected');
        }
        document.getElementById('bet1_field').value = bet;
        if (currentStage === 'bet' && !betMade) {
            liveSend({ bet: bet, initial_bet_time: performance.now() - betPhaseStartTime, id: js_vars.player_id });
            betMade = true;
        }
    }

    function selectSecondBet(bet) {
        const betElements = document.querySelectorAll('.bet-options div');
        betElements.forEach(element => {
            element.classList.remove('selected');
            element.classList.remove('selected-from-previous');
        });
        const selectedBetElement = document.querySelector(`.bet-options div[data-bet="${bet}"]`);
        if (selectedBetElement) {
            selectedBetElement.classList.add('selected');
        }
        document.getElementById('bet2_field').value = bet;
    }

    function startBetTimer() {
        if (!betTimerStarted) {
            betTimerStarted = true;
            document.getElementById('bet-container').style.display = 'block';
            document.getElementById('choice-title').style.display = 'none';
            document.getElementById('bet-title').style.display = 'block';
            currentStage = 'bet';
            betMade = false;
            document.addEventListener('keydown', handleKeyDown);
            betPhaseStartTime = performance.now();

            setTimeout(function() {
                liveSend({bet_timer_ended: true});
                document.removeEventListener('keydown', handleKeyDown);
                betTimerStarted = false;
            }, 900);
        }
    }

    function startSecondChoiceTimer() {
        document.getElementById('choice-title').style.display = 'none';
        document.getElementById('second-choice-title').style.display = 'block';
        currentStage = 'second_choice';
        secondChoiceMade = false;
        document.addEventListener('keydown', handleKeyDown);
        secondChoiceStartTime = performance.now();

        setTimeout(function() {
            if (!secondChoiceMade) {
                liveSend({second_choice_timer_ended: true});
                document.removeEventListener('keydown', handleKeyDown);
            }
        }, 900);
    }

    function startSecondBetTimer() {
        document.getElementById('bet-container').style.display = 'block';
        document.getElementById('second-choice-title').style.display = 'none';
        document.getElementById('second-bet-title').style.display = 'block';
        currentStage = 'second_bet';
        secondBetMade = false;
        secondBetPhaseEnded = false;
        document.addEventListener('keydown', handleKeyDown);
        secondBetStartTime = performance.now();

        setTimeout(function() {
            secondBetPhaseEnded = true;
            liveSend({second_bet_timer_ended: true});
            document.removeEventListener('keydown', handleKeyDown);
        }, 900);
    }

    let connectedPlayers = new Set();
    let lastConnectionTime = {};
    const THROTTLE_TIME = 2000; // 2 seconds

    function throttle(playerId, action) {
        const now = Date.now();
        if (!lastConnectionTime[playerId] || now - lastConnectionTime[playerId] > THROTTLE_TIME) {
            lastConnectionTime[playerId] = now;
            return true;
        }
        return false;
    }

    function updateConnectedPlayers(players) {
        console.log("Connected players:", Array.from(players));
    }

    function playerConnected(playerId) {
        if (!connectedPlayers.has(playerId) && throttle(playerId, 'connect')) {
            connectedPlayers.add(playerId);
            updateConnectedPlayers(connectedPlayers);
            liveSend({type: 'player_connected', player_id: playerId});
            console.log(`Player ${playerId} connected`);
        }
    }

    function playerDisconnected(playerId) {
        if (connectedPlayers.has(playerId) && throttle(playerId, 'disconnect')) {
            connectedPlayers.delete(playerId);
            updateConnectedPlayers(connectedPlayers);
            liveSend({type: 'player_disconnected', player_id: playerId});
            console.log(`Player ${playerId} disconnected`);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        playerConnected(js_vars.player_id);
    });

    window.addEventListener('beforeunload', function() {
        playerDisconnected(js_vars.player_id);
    });

    function liveRecv(data) {
        console.log('Received data:', data);

        if (data.type === 'player_connected') {
            playerConnected(data.player_id);
        } else if (data.type === 'player_disconnected') {
            playerDisconnected(data.player_id);
        }

        if ('start_choice_phase_timer' in data && data.start_choice_phase_timer && !window.choicePhaseTimerStarted) {
            window.choicePhaseTimerStarted = true;
            document.getElementById('option-container').style.display = 'block';
            document.getElementById('choice-title').style.display = 'block';
            choicePhaseStartTime = performance.now();
            
            initialChoiceTimerId = setTimeout(function() {
                console.log('Timer ended, sending choice_phase_timer_ended event');
                liveSend({
                    choice_phase_timer_ended: true,
                    actual_choice_time: 900
                });
            }, 900);
        }

        if (('start_bet_timer' in data && data.start_bet_timer) || 
            ('show_bet_container' in data && data.show_bet_container)) {
            startBetTimer();
        }

        if ('highlight_selected_choice' in data) {
            const selectedOption = document.getElementById(`option_${data.highlight_selected_choice}`);
            const otherOption = document.getElementById(`option_${data.highlight_selected_choice === 'left' ? 'right' : 'left'}`);
            selectedOption.classList.add('selected');
            otherOption.classList.remove('selected');
        }

        if ('highlight_selected_bet' in data) {
            const betElements = document.querySelectorAll('.bet-options div');
            betElements.forEach(element => {
                element.classList.remove('selected');
            });
            const selectedBetElement = document.querySelector(`.bet-options div[data-bet="${data.highlight_selected_bet}"]`);
            if (selectedBetElement) {
                selectedBetElement.classList.add('selected');
            }
        }

        if ('highlight_computer_bet' in data) {
            selectBet(data.highlight_computer_bet);
        }

        if ('display_all_images' in data && data.display_all_images) {
            const allImages = data.all_images;
            console.log('Displaying all images:', allImages);
            
            Object.entries(allImages).forEach(([playerId, imagePath]) => {
                const avatarWrapper = document.querySelector(`.avatar-wrapper[data-player-id="${playerId}"]`);
                if (avatarWrapper) {
                    const chosenImageElement = avatarWrapper.querySelector('.chosen-image-first');
                    chosenImageElement.src = `/static/${imagePath}`;
                    chosenImageElement.style.display = 'block';
                    console.log(`Displayed image for player ${playerId}: ${imagePath}`);
                } else {
                    console.error(`No avatar wrapper found for player ${playerId}`);
                }
            });

            if (!window.allImagesDisplayed) {
                console.log('Sending all_images_displayed event');
                liveSend({all_images_displayed: true});
                window.allImagesDisplayed = true;
            }
        }

        if ('start_second_choice_timer' in data && data.start_second_choice_timer) {
            startSecondChoiceTimer();
        }

        if ('highlight_selected_image' in data) {
            const selectedOption = document.querySelector(`#option_${data.highlight_selected_image === '{{ player.left_image }}' ? 'left' : 'right'}`);
            const otherOption = document.querySelector(`#option_${data.highlight_selected_image === '{{ player.left_image }}' ? 'right' : 'left'}`);
            selectedOption.classList.add('selected');
            selectedOption.classList.remove('selected-from-previous');
            otherOption.classList.remove('selected');
            otherOption.classList.remove('selected-from-previous');
        }

        if ('start_second_bet_timer' in data && data.start_second_bet_timer) {
            startSecondBetTimer();
        }

        if ('show_results' in data && data.show_results && !resultsShown) {
            resultsShown = true;
            secondBetPhaseEnded = true;

            const chosenImagesSecondChoice = data.chosen_images;
            console.log('chosenImagesSecondChoice:', chosenImagesSecondChoice);

            const winLossImages = data.win_loss_images;
            const avatarWrappers = document.querySelectorAll('.avatar-wrapper');
            avatarWrappers.forEach((wrapper, index) => {
                const playerId = window.otherPlayerIds[index];
                const chosenImageSecondChoice = wrapper.querySelector('.chosen-image-second');
                console.log(`Updating chosen image for player ${playerId}:`, chosenImagesSecondChoice[playerId]);
                chosenImageSecondChoice.src = `/static/${chosenImagesSecondChoice[playerId]}`;
                chosenImageSecondChoice.style.display = 'block';

                const winLossImage = wrapper.querySelector('.win-loss-image');
                winLossImage.src = `/static/${winLossImages[playerId]}`;
                winLossImage.style.display = 'block';
            });

            // Display the win/loss image for the current participant
            const playerWinLossImage = data.player_win_loss_image;
            document.getElementById('player-win-loss-image').src = `/static/${playerWinLossImage}`;
            document.getElementById('player-win-loss-container').style.display = 'block';

            // Modify this part to ensure the bet is highlighted
            const betContainer = document.getElementById('bet-container');
            betContainer.style.pointerEvents = 'none';
            betContainer.style.opacity = '1.0';

            // Ensure the selected bet is highlighted
            if (data.selected_bet) {
                selectSecondBet(data.selected_bet);
            }

            // Hide the 'Second bet?' text
            document.getElementById('second-bet-title').style.display = 'none';

            // Display the calculated reward based on the second bet for the current participant
            const secondBetReward = data.second_bet_reward;
            document.getElementById('trial-reward').textContent = `${secondBetReward} points`;
            document.getElementById('trial-reward').style.display = 'block';

            // Set a timeout to log a message and transition to the next round after the intertrial interval has finished
            setTimeout(() => {
                console.log(`Intertrial interval of ${data.intertrial_interval}ms has finished.`);
                console.log(`Round ${data.round_number} finished. Transitioning to the next round.`);

                // Set default values for the choice2 and bet2 fields if they are empty
                const choice2Field = document.getElementById('choice2_field');
                const bet2Field = document.getElementById('bet2_field');

                if (!choice2Field.value) {
                    choice2Field.value = 'left'; // Set a default value (e.g., 'left')
                }

                if (!bet2Field.value) {
                    bet2Field.value = 1; // Set a default value (e.g., 1)
                }

                setTimeout(function() {
                    document.getElementById('form').submit();
                    console.log('Form submitted');
                }, 100);
            }, data.intertrial_interval);
        }
    }
</script>

{{ endblock }}
{% extends "global/Page.html" %}
{% load staticfiles otree %}
{% load otree %}

{{ block content }}

<style>

    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    #content {
        height: 100vh;
        overflow-y: auto;
    }

    body {
        background-color: black;
        color: white;
        font-size: 24px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        height: 150vh;
        margin: 0;
        transform: scale(1.1);
        transform-origin: top center;
    }

    #option-container {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        width: 900px;
        height: 600px;
        border: 7.5px solid white;
        padding: 30px;
        box-sizing: border-box;
    }

    #options {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
        margin-top: 45%;
        position: relative;
    }

    #options img {
        width: 10%;
        margin: 0;
    }

    #option_left {
        position: absolute;
        left: 25%;
        transform: translateX(-50%);
    }

    #option_right {
        position: absolute;
        right: 25%;
        transform: translateX(50%);
    }

    .title {
        text-align: center;
        position: absolute;
        top: -45px;
        left: 50%;
        transform: translateX(-50%);
        white-space: pre-line;
    }

    #preference-title {
        top: -90px;
    }

    .selected {
        border: 4.5px solid yellow;
    }

    .bet-options {
        display: flex;
        justify-content: center;
        margin-top: 60px;
    }

    .bet-options div {
        margin: 0 15px;
        padding: 7.5px 15px;
        cursor: pointer;
    }

    .bet-options div.selected {
        border: 3px solid yellow;
    }

    #avatar-container {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        top: 105px;
        left: -25px;
    }

    .avatar-wrapper {
        position: relative;
        display: inline-block;
        margin: 0 15px;
    }

    .avatar-number {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 20px;
        font-weight: bold;
        color: black;
        z-index: 1;
    }

    .avatar {
        width: 75px;
        height: 75px;
    }

    .chosen-image {
        width: 45px;
        height: 45px;
        position: absolute;
        top: 82.5px;
        left: 15px;
    }

    .second-chosen-image {
        width: 45px;
        height: 45px;
        position: absolute;
        top: 82.5px;
        left: 15px;
    }

    .remaining-image {
        width: 45px;
        height: 45px;
        position: absolute;
        top: 82.5px;
        left: 15px;
    }

    .avatar-selected {
        border: 4.5px solid rgb(249, 0, 0);
    }

    .avatar-selected-second-choice {
        border: 4.5px solid rgb(255, 166, 0);
    }

    .otree-timer {
        display: none;
    }
</style>

<div id="avatar-container">
    {% for player_id in other_player_ids %}
        <div class="avatar-wrapper" data-player-id="{{ player_id }}">
            <img src="{% static avatar_image %}" alt="Player {{ player_id }} Avatar" class="avatar">
            <div class="avatar-number">{{ forloop.counter }}</div>
            <img src="" alt="Player {{ player_id }} Chosen Image" class="chosen-image" style="display: none;">
        </div>
    {% endfor %}
</div>

<script>
    window.otherPlayerIds = {{ other_player_ids|json }};
</script>

<div id="option-container">
    <div id="options">
        <img src="{% static left_image %}" id="option_left" data-option="left">
        <img src="{% static right_image %}" id="option_right" data-option="right">
        <div class="title" id="choice-title">Your choice?</div>
        <div class="title" id="bet-title" style="display: none;">Your bet?</div>
    </div>
    <div id="bet-container" style="display: none;">
        <div class="bet-options">
            <div data-bet="1">1</div>
            <div data-bet="2">2</div>
            <div data-bet="3">3</div>
        </div>
    </div>
</div>

<script>
    window.js_vars = {
        player_id: {{ player_id }},
    };

    document.addEventListener('DOMContentLoaded', function() {
        liveSend({my_page_load_time: performance.now()});
        initialChoiceTimerId = setTimeout(function() {
            if (currentStage === 'choice') {
                liveSend({initial_choice_time: 8000});
            }
        }, 8000);

        window.choicePhaseStartTime = performance.now();
    });

    window.betPhaseStartTime = null;

    let initialChoiceTime;
    let initialBetTime;
    let currentStage = 'choice';
    let initialChoiceTimerId;
    let choiceMade = false;
    let betMade = false;

    function handleKeyDown(event) {
        console.log('Key pressed:', event.key);
        console.log('Current stage:', currentStage);

        if (currentStage === 'choice' && (event.key === 'ArrowLeft' || event.key === 'ArrowRight') && !choiceMade) {
            initialChoiceTime = performance.now() - window.choicePhaseStartTime;
            liveSend({initial_choice_time: initialChoiceTime, choice: event.key === 'ArrowLeft' ? 'left' : 'right'});
            choose(event.key === 'ArrowLeft' ? 'left' : 'right');
            choiceMade = true;
            clearTimeout(initialChoiceTimerId);
        } else if (currentStage === 'bet' && (event.key >= '1' && event.key <= '3') && !betMade) {
            const bet = parseInt(event.key);
            const initialBetTime = performance.now() - window.betPhaseStartTime;
            liveSend({initial_bet_time: initialBetTime, bet: bet, id: js_vars.player_id});
            selectBet(bet);
            betMade = true;
        }
    }

    document.addEventListener('keydown', handleKeyDown);

    function choose(option) {
        if (currentStage === 'choice' && !choiceMade) {
            const selectedOption = document.getElementById(`option_${option}`);
            const otherOption = document.getElementById(`option_${option === 'left' ? 'right' : 'left'}`);
            selectedOption.classList.add('selected');
            otherOption.classList.remove('selected');
            choiceMade = true;
        }
    }

    function selectBet(bet) {
        if (currentStage === 'bet' && !betMade) {
            const betElements = document.querySelectorAll('.bet-options div');
            betElements.forEach(element => {
                element.classList.remove('selected');
            });
            document.querySelector(`.bet-options div[data-bet="${bet}"]`).classList.add('selected');
            liveSend({ bet: bet });
            betMade = true;
            document.removeEventListener('keydown', handleKeyDown);
        }
    }

    function liveRecv(data) {
        console.log('Received data:', data);
        console.log('Current stage:', currentStage);

        if ('my_page_load_time' in data) {
            window.myPageLoadTime = data.my_page_load_time;
        }

        if ('start_choice_phase_timer' in data && data.start_choice_phase_timer && !window.choicePhaseTimerStarted) {
            window.choicePhaseTimerStarted = true;
            setTimeout(function() {
                liveSend({choice_phase_timer_ended: true});
            }, 8000);
        }

        if ('choice_phase_timer_ended' in data) {
            console.log("Choice phase timer ended for all players in the group");
            liveSend({show_bet_container: true});
        }

        if ('computer_choice' in data) {
            const selectedOption = document.getElementById(`option_${data.computer_choice}`);
            const otherOption = document.getElementById(`option_${data.computer_choice === 'left' ? 'right' : 'left'}`);
            selectedOption.classList.add('selected');
            otherOption.classList.remove('selected');
        }

        if ('highlight_selected_choice' in data) {
            const selectedOption = document.getElementById(`option_${data.highlight_selected_choice}`);
            const otherOption = document.getElementById(`option_${data.highlight_selected_choice === 'left' ? 'right' : 'left'}`);
            selectedOption.classList.add('selected');
            otherOption.classList.remove('selected');
        }

        if ('highlight_selected_image' in data) {
            const selectedOption = document.querySelector(`#option_${data.highlight_selected_image.includes('option1A') ? 'left' : 'right'}`);
            const otherOption = document.querySelector(`#option_${data.highlight_selected_image.includes('option1A') ? 'right' : 'left'}`);
            selectedOption.classList.add('selected');
            otherOption.classList.remove('selected');
        }

        if ('start_bet_timer' in data && data.start_bet_timer && !window.betTimerStarted) {
            window.betTimerStarted = true;
            setTimeout(function() {
                if (!betMade) {
                    liveSend({bet_timer_ended: true});
                }
            }, 8000);
        }

        if ('show_bet_container' in data && data.show_bet_container) {
            document.getElementById('bet-container').style.display = 'block';
            document.getElementById('choice-title').style.display = 'none';
            document.getElementById('bet-title').style.display = 'block';
            currentStage = 'bet';
            betMade = false;
            document.addEventListener('keydown', handleKeyDown);
            window.betPhaseStartTime = performance.now();
            window.betContainerLoadTime = performance.now();

            setTimeout(function() {
                if (!betMade) {
                    liveSend({bet_timer_ended: true});
                } else {
                    liveSend({bet_timer_ended: true});
                }
                document.removeEventListener('keydown', handleKeyDown);
            }, 8000);
        }

        if ('highlight_selected_bet' in data) {
            const betElements = document.querySelectorAll('.bet-options div');
            betElements.forEach(element => {
                element.classList.remove('selected');
            });
            document.querySelector(`.bet-options div[data-bet="${data.highlight_selected_bet}"]`).classList.add('selected');
        }

        if (data.hasOwnProperty('computer_assigned_bet')) {
            console.log('Received computer_assigned_bet:', data.computer_assigned_bet);
            $('.bet-options > div').removeClass('selected');
            $(`.bet-options > div[data-bet="${data.computer_assigned_bet}"]`).addClass('selected');
            betMade = true;
        }

        if (data.hasOwnProperty('show_bet_container') && data.show_bet_container) {
            $('#bet-container').show();
            $('#bet-title').show();
            $('#choice-title').hide();
            currentStage = 'bet';
            betMade = false;
            document.addEventListener('keydown', handleKeyDown);
            window.betPhaseStartTime = performance.now();
        }

        if ('display_all_images' in data && data.display_all_images) {
            console.log('Displaying all images for all players');
            const allImages = data.all_images;
            Object.keys(allImages).forEach(playerId => {
                const avatarWrapper = document.querySelector(`.avatar-wrapper[data-player-id="${playerId}"]`);
                if (avatarWrapper) {
                    const chosenImageElement = avatarWrapper.querySelector('.chosen-image');
                    chosenImageElement.src = `/static/${allImages[playerId]}`;
                    chosenImageElement.style.display = 'block';
                }
            });

            setTimeout(() => {
                liveSend({all_images_displayed: true});
            }, 100);
        }

        if ('redirect_to_second_choice' in data && data.redirect_to_second_choice) {
            console.log('Redirecting to SecondChoicePage');
            setTimeout(() => {
                document.getElementById('form').submit();
            }, 500);
        }
    }

    $('.bet-options > div').click(function() {
        if (!betMade) {
            betMade = true;
            $('.bet-options > div').removeClass('selected');
            $(this).addClass('selected');
            var bet = $(this).attr('data-bet');
            var betTime = performance.now() - window.betPhaseStartTime;
            liveSend({
                'bet': bet,
                'initial_bet_time': betTime,
                'id': js_vars.player_id
            });
        }
    });

    // Time players out after 80 seconds spent on MyPage
    document.addEventListener('DOMContentLoaded', function() {
        const pageStartTime = js_vars.page_start_time;
        const timeoutDuration = 80000; // 80 seconds in milliseconds

        function checkTimeout() {
            const currentTime = new Date().getTime();
            if (currentTime - pageStartTime >= timeoutDuration) {
                document.getElementById('form').submit();
            } else {
                setTimeout(checkTimeout, 1000); // Check every second
            }
        }

        setTimeout(checkTimeout, 1000); // Start checking after 1 second
    });

</script>

{{ endblock }}